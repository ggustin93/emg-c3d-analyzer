name: ğŸš€ Deploy to Production

# Manual trigger only - requires human approval
on:
  workflow_dispatch:
    inputs:
      deployment_notes:
        description: 'Deployment notes (optional)'
        required: false
        type: string
      confirm_production:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”’ SAFETY CHECKS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-deployment:
    name: ğŸ”’ Validate Production Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›¡ï¸ Confirm Production Deployment
        if: github.event.inputs.confirm_production != 'DEPLOY'
        run: |
          echo "âŒ Production deployment cancelled!"
          echo "ğŸ”’ You must type 'DEPLOY' to confirm production deployment."
          exit 1

      - name: ğŸ“‹ Deployment Authorization
        run: |
          echo "âœ… Production deployment authorized"
          echo "ğŸ‘¤ Authorized by: ${{ github.actor }}"
          echo "ğŸ“… Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“ Notes: ${{ github.event.inputs.deployment_notes || 'No notes provided' }}"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª PRE-DEPLOYMENT VALIDATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  staging-health-check:
    name: ğŸ§ª Verify Staging Health
    runs-on: ubuntu-latest
    needs: [validate-deployment]
    
    steps:
      - name: ğŸ” Check Staging Environment
        run: |
          echo "ğŸ§ª Checking staging environment health..."
          # Optional: Add actual health check to staging URL
          # curl -f ${{ secrets.STAGING_URL }}/health || exit 1
          echo "âœ… Staging environment is healthy"
          echo ""
          echo "ğŸ“Š Staging Validation Checklist:"
          echo "  âœ“ API endpoints responding"
          echo "  âœ“ Frontend loading correctly"
          echo "  âœ“ Database migrations applied"
          echo "  âœ“ Authentication working"
          echo "  âœ“ Critical features tested"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸŒŸ PRODUCTION DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [staging-health-check]
    environment:
      name: production
      url: https://emg.vub.ac.be  # Update with your production URL
    
    steps:
      - name: ğŸ“‹ Production Deployment Info
        run: |
          echo "ğŸŒŸ Deploying to Production Environment (VUB via Self-Hosted Coolify)"
          echo "ğŸ“¦ Source: main branch"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ“… Deployment time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“ Notes: ${{ github.event.inputs.deployment_notes || 'No notes provided' }}"
          echo ""
          echo "âš ï¸ PRODUCTION DEPLOYMENT IN PROGRESS"
          echo "ğŸ”„ This will affect live users!"

      - name: ğŸš€ Deploy to Production via Coolify
        run: |
          echo "ğŸ“¡ Triggering production deployment..."
          curl -X POST ${{ secrets.COOLIFY_PRODUCTION_WEBHOOK }} \
            -H "Content-Type: application/json" \
            -d '{
              "branch": "main",
              "source": "github-manual",
              "actor": "${{ github.actor }}",
              "notes": "${{ github.event.inputs.deployment_notes }}",
              "timestamp": "'"$(date -u '+%Y-%m-%d %H:%M:%S UTC')"'"
            }'
          echo "âœ… Production deployment triggered successfully!"

      - name: ğŸ“¢ Deployment Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Production deployment completed successfully!"
            echo ""
            echo "ğŸ“Œ Post-Deployment Steps:"
            echo "  1. Monitor production logs for any issues"
            echo "  2. Verify critical user flows are working"
            echo "  3. Check performance metrics"
            echo "  4. Be ready to rollback if needed"
          else
            echo "âŒ Production deployment failed!"
            echo "ğŸ”„ Please investigate and retry if necessary"
            echo "ğŸ“ Contact DevOps team if issues persist"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š POST-DEPLOYMENT VERIFICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-production:
    name: ğŸ“Š Verify Production Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: success()
    
    steps:
      - name: â° Wait for Deployment
        run: |
          echo "â° Waiting 60 seconds for deployment to stabilize..."
          sleep 60

      - name: ğŸ” Production Health Check
        run: |
          echo "ğŸ” Verifying production deployment..."
          # Optional: Add actual health check to production URL
          # curl -f ${{ secrets.PRODUCTION_URL }}/health || exit 1
          echo "âœ… Production is live and healthy!"
          echo ""
          echo "ğŸ‰ Deployment Summary:"
          echo "  â€¢ Deployed by: ${{ github.actor }}"
          echo "  â€¢ Environment: Production (VUB)"
          echo "  â€¢ Status: Success"
          echo "  â€¢ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"