# EMG C3D Analyzer (GHOSTLY+)

A web-based tool for the analysis and visualization of Electromyography (EMG) data from C3D files, specifically designed and customized for C3D files generated by the GHOSTLY rehabilitation serious game platform.

> âš ï¸ **Work in Progress**: This application is currently under active development. Some features are incomplete and EMG analysis algorithms have not yet been clinically validated. This tool is specifically customized for C3D files from the GHOSTLY serious game and may not work correctly with C3D files from other sources without modification.

![EMG C3D Analyzer Screenshot](assets/screenshot-v2.webp)
![EMG C3D Analyzer Screenshot 2](assets/performance-v2.webp)

## Core Features

*   **GHOSTLY-Specific C3D Processing:** Ingests C3D files from the GHOSTLY game and distinguishes between "Raw" and "Activated" EMG signals based on GHOSTLY's specific channel naming conventions. *Note: Research is ongoing to understand the processing applied to "Activated" channels for optimal temporal analysis implementation.*
*   **EMG Analytics (WIP):** Calculates basic metrics for muscle fatigue and activity, including RMS, MAV, MPF, MDF, and Dimitrov's Fatigue Index. *Note: Statistical analysis and clinical validation are currently in development.*
*   **Contractions Detection & Analysis:** Identifies muscle contractions using adaptive thresholding with configurable parameters for duration and amplitude, providing detailed metrics on contraction count, duration, and intensity.
*   **Advanced Contraction Visualization:** Real-time visual feedback with background highlighting for contraction periods and peak markers with quality indicators (âœ“/âœ—). Features interactive toggle controls for Good/Poor contractions and Areas/Dots visibility.
*   **Performance Analysis of Rehabilitation Sessions:** Evaluates rehabilitation progress through analysis of contractions and exercise quality metrics compared to the rehabilitation protocol.
*   **Interactive Visualization:** Real-time EMG signal plotting with multi-channel comparison, comprehensive performance metrics dashboard, and dynamic legend showing contraction quality statistics.
*   **Session Configuration:** Game session parameter management with MVC threshold settings and basic performance tracking.
*   **Stateless Architecture:** Optimized for cloud deployment with efficient data bundling and client-side processing.
*   **Modern Technology Stack:** Built with FastAPI backend and React/TypeScript frontend with Zustand state management.

## Technology Stack

### Backend
- **Runtime:** Python 3.10+, FastAPI, Uvicorn
- **Authentication:** Supabase Auth with role-based access control
- **Database:** Supabase (PostgreSQL) with real-time subscriptions
- **Scientific:** `ezc3d`, `pandas`, `numpy`, `scipy` for EMG analysis
- **Package Management:** Poetry

### Frontend
- **Framework:** React 19 with TypeScript
- **Build System:** CRACO (planned: Vite migration)
- **UI Components:** Tailwind CSS, shadcn/ui, Radix UI
- **State Management:** Zustand for session parameters
- **Visualization:** Recharts for interactive EMG signal plotting
- **Authentication:** Supabase client integration

#### Theming
- **Primary color:** `#0ecfc5` (HSL â‰ˆ `hsl(177 87% 43%)`) configured via CSS variables in `frontend/src/index.css` as `--primary` and `--ring`.
- **Usage:** Components consume `bg-primary`, `text-primary-foreground`, `border-primary` via shadcn tokens.
- **Tabs:** App tabs (see `GameSessionTabs.tsx`) use the primary tokens for the active state.
- **Secondary color (recommendation):** deep medical blue (e.g., `#0B4F6C`) for secondary emphasis, info states, or headings if desired.

### Development & Deployment
- **Development:** Automated setup scripts, hot reload
- **Testing:** Jest (frontend), pytest (backend)
- **Code Quality:** ESLint, TypeScript strict mode
- **Deployment:** Stateless architecture optimized for cloud platforms
- **AI Development:** Claude Code with MCP server integration

---

## Disclaimers

### ğŸš§ Development Status
This application is actively under development with several features in various stages of completion:
- **EMG Analysis Algorithms**: Basic implementation complete, but statistical analysis and clinical validation are ongoing
- **Channel Detection**: Currently optimized for GHOSTLY C3D file format and channel naming conventions
- **Performance Metrics**: Calculations implemented but may require clinical validation for research use
- This tool is intended for research and educational purposes within the GHOSTLY rehabilitation game context.

---

## Getting Started

### Prerequisites

*   Git
*   Python 3.10+
*   Poetry
*   Node.js (LTS) & npm

### 1. Clone & Setup

First, clone the repository:
```bash
git clone https://github.com/ggustin93/emg-c3d-analyzer.git
cd emg-c3d-analyzer
```
### 2. Configure Virtual Environment (Recommended)

To ensure the `start_dev.sh` script works seamlessly, configure Poetry to create the virtual environment inside the project folder:
```bash
poetry config virtualenvs.in-project true
```

### 3. Run the Development Environment

The `start_dev.sh` script is the recommended way to launch the entire application. It handles all dependencies and starts both the backend and frontend servers concurrently.

**First, make the script executable:**
```bash
chmod +x start_dev.sh
```

**To run the development server:**
```bash
./start_dev.sh
```
*   **Backend API:** `http://localhost:8080`
*   **Frontend App:** `http://localhost:3000`

**For a clean dependency reinstall (if you encounter module errors):**
```bash
./start_dev.sh --clean
```
This will delete `node_modules` and `package-lock.json` before installing, which can resolve caching issues.

---

## Configuration

### Frontend API Endpoint

The frontend defaults to connecting to the backend at `http://localhost:8080`. To override this (for example, in a production deployment), you can either:

1.  Create a `frontend/.env` file with `REACT_APP_API_URL=your_backend_url`.
2.  Set the `REACT_APP_API_URL` as an environment variable in your deployment platform (e.g., Vercel, Netlify).

---

## Project Structure

```
emg-c3d-analyzer/
â”œâ”€â”€ backend/                           # FastAPI application source
â”‚   â”œâ”€â”€ api.py                         # REST API endpoints
â”‚   â”œâ”€â”€ processor.py                   # C3D file processing logic (legacy orchestrator)
â”‚   â”œâ”€â”€ emg_analysis.py                # EMG metrics and contraction analysis (domain logic)
â”‚   â”œâ”€â”€ signal_processing.py           # Standardized EMG processing pipeline (domain logic)
â”‚   â”œâ”€â”€ export_utils.py                # Export utilities (infrastructure)
â”‚   â”œâ”€â”€ models.py                      # Pydantic data models
â”‚   â”œâ”€â”€ domain/                        # DDD: domain layer (compatibility re-exports)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ analysis.py                # Re-exports from emg_analysis
â”‚   â”‚   â”œâ”€â”€ models.py                  # Re-exports from models
â”‚   â”‚   â””â”€â”€ processing.py              # Re-exports from signal_processing
â”‚   â”œâ”€â”€ application/                   # DDD: application layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ processor_service.py       # Wrapper for legacy processor
â”‚   â”œâ”€â”€ infrastructure/                # DDD: infrastructure layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ exporting.py               # Re-exports for export utilities
â”‚   â””â”€â”€ tests/                         # Backend tests
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ domain/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ test_contraction_flags.py  # Contract tests for contraction flags logic
â”œâ”€â”€ frontend/                          # React TypeScript application
â”‚   â”œâ”€â”€ public/                        # Static assets and index.html
â”‚   â””â”€â”€ src/                           # Application source code
â”‚       â”œâ”€â”€ components/                # Reusable UI components
â”‚       â”œâ”€â”€ hooks/                     # Custom React hooks
â”‚       â”œâ”€â”€ store/                     # Zustand state management
â”‚       â”œâ”€â”€ types/                     # TypeScript type definitions
â”‚       â””â”€â”€ utils/                     # Utility functions
â”œâ”€â”€ docs/                              # Technical documentation
â”‚   â”œâ”€â”€ api.md
â”‚   â”œâ”€â”€ signal-processing.md           # Pipeline and parameters
â”‚   â””â”€â”€ architecture-ddd.md            # DDD scaffold overview
â”œâ”€â”€ memory-bank/                       # Project memory & tasks
â”œâ”€â”€ assets/                            # Images and assets
â”œâ”€â”€ start_dev.sh                       # Dev environment setup script
â””â”€â”€ README.md
```

## ğŸ“š Documentation

### For Developers
- **[Quick Start Guide](./docs/)** - Development setup and workflow
- **[API Reference](./docs/api.md)** - FastAPI endpoints and models
- **[Signal Processing](./docs/signal-processing.md)** - EMG pipeline and parameters
- **[Architecture (DDD)](./docs/architecture-ddd.md)** - Backend layering overview
- **[Database Schema](./docs/db_schema.md)** - Supabase database structure
- **[MCP Setup](./docs/setup/mcp-setup.md)** - Claude Code MCP configuration

### For AI Development
- **[Claude Instructions](./CLAUDE.md)** - AI development context and memory bank guide

## Development Roadmap

### ğŸ¯ Current Focus
- **Enhanced EMG Statistical Analysis**: Implementation of clinically sound average and standard deviation calculations for all metrics
- **Algorithm Validation**: Clinical validation of EMG analysis algorithms with reference datasets
- **Documentation**: Comprehensive API documentation and EMG analysis methodology

### âœ… Recently Completed
- **Authentication System** (July 2025): Complete Supabase authentication with role-based access control
- **Contraction Visualization System**: Real-time visual feedback with background highlighting and peak markers
- **Interactive Chart Controls**: Toggle controls for contraction quality and visualization elements
- **Performance Analysis**: Clinical scoring system with configurable BFR monitoring
- **Documentation Architecture**: Streamlined 2-layer documentation strategy
 - **Role-Gated Settings & Theming** (Aug 2025): Therapist-only gating for Performance Scoring & Therapeutic Parameters with Debug override; Read-only ePRO & Contraction Detection; Primary color set to `#0ecfc5`; tabs use primary tokens; scoring normalization UI disabled when `S_game` weight is 0%.

### ğŸ”œ Planned Features
- **CRACO to Vite Migration**: Faster development builds and modern tooling
- **Multi-session Analysis**: Compare EMG data across multiple GHOSTLY game sessions
- **Export Capabilities**: Data export in standard research formats (CSV, MATLAB, etc.)
- **Advanced Filtering**: Configurable EMG signal preprocessing options
- **Performance Optimization**: Enhanced processing speed for large C3D files

## License

This project is licensed under the MIT License. See the `LICENSE.md` file for details.
