# GHOSTLY+ EMG C3D Analyzer

<!-- 
DOCUMENTATION TONE GUIDELINES:
- Keep language humble, concise, and factual
- Avoid promotional terms: "cutting-edge", "comprehensive", "advanced", "clinical-first"
- Use neutral descriptive language instead of marketing language
- State capabilities without overselling
- Focus on what the system does, not how amazing it is
- Remove excessive adjectives and superlatives
- Be direct and professional
-->

⚠️ **Important Notice**

This repository is a research-focused EMG analysis platform, initiated as part of the GHOSTLY+ rehabilitation gaming project. The codebase is under active development and contains incomplete features that have not been clinically validated. It is specifically designed for C3D files generated by the GHOSTLY serious game platform and is not intended for medical diagnosis or production clinical use.

This project is a full-stack web application designed to analyze Electromyography (EMG) data from C3D motion capture files. It demonstrates rehabilitation technology architecture using React, FastAPI, and EMG signal processing algorithms for therapeutic assessment and research.

![EMG Analysis Dashboard](assets/screenshot-v2.webp)

**Table of Contents**
- [Features](#1-features)
- [Preview](#2-preview)
- [Architecture Overview](#3-architecture-overview)
- [Tech Stack](#4-tech-stack)
- [Testing Strategy](#5-testing-strategy)
- [Development Scripts](#6-development-scripts)
- [Local Development](#7-local-development)
- [Roadmap](#8-roadmap)
- [License](#9-license)

## 1. Features

**EMG Data Processing**: Upload C3D files with drag-and-drop interface and extraction of raw and processed EMG signals using GHOSTLY-specific channel detection.

**Signal Analysis**: Calculate EMG metrics including RMS amplitude, Mean Absolute Value (MAV), spectral parameters (MPF, MDF), and fatigue indices with temporal windowing.

**Contraction Detection**: Automated muscle contraction identification with configurable MVC thresholds and duration criteria.

**Visualization**: Interactive EMG signal plotting with multi-channel comparison, zoom/pan capabilities, and contraction highlighting.

**Configuration**: Configurable muscle naming, color coding, and session parameter management with role-based access controls.

**Analytics**: Performance scoring system with completion, intensity, and duration metrics, plus Blood Flow Restriction (BFR) monitoring.

**Authentication**: Supabase authentication with secure file storage, role-based permissions, and session management.

## 2. Preview

Here's a visual overview of the application's key features:

### 2.1 EMG Signal Analysis Dashboard
![EMG Signal Dashboard](assets/screenshot-v2.webp)
The main analysis interface showing multi-channel EMG signals with real-time contraction detection, MVC threshold visualization, and interactive controls for signal type switching (Raw/Activated).

### 2.2 Performance Analytics & Clinical Scoring
![Performance Analytics](assets/performance-v2.webp)
Comprehensive performance analysis with muscle-specific compliance scoring, therapeutic parameters, and visual analytics for rehabilitation progress tracking with BFR monitoring integration.

## 3. Architecture Overview

The GHOSTLY+ EMG Analyzer implements a full-stack architecture for stateless data processing and EMG visualization. The system processes C3D motion capture files and generates EMG analytics.

**Processing Workflow**: When a user uploads a C3D file, the system: **(1)** Parses C3D files using ezc3d library, **(2)** Calculates EMG metrics (RMS, MAV, MPF, MDF, fatigue indices), **(3)** Detects muscle contractions using configurable thresholds, **(4)** Packages analysis results in a single API response, and **(5)** Renders interactive charts in the React frontend. The frontend uses Zustand for state management and updates the UI without server round-trips.

### 3.1 High-Level Diagram
```
┌─────────────────────────┐      ┌───────────────────────────┐      ┌─────────────────────────┐
│    React 19 Frontend    │◄──── │     FastAPI Backend       │ ───► │   Supabase Platform     │
│ (Zustand, TypeScript)   │ HTTP │  (EMG Processing Engine)  │ SQL  │ (PostgreSQL & Storage)  │
├─────────────────────────┤      ├───────────────────────────┤      ├─────────────────────────┤
│ - Zustand State Store   │      │ - C3DProcessor            │      │ - Session Parameters    │
│ - Component Architecture│      │ - EMGAnalysis Engine      │      │ - Authentication        │
│ - Interactive Charts    │      │ - Signal Processing       │      │ - File Storage          │
│ - Real-Time UI Updates  │      │ - Statistical Analysis    │      │ - Clinical Data Schema  │
└─────────────────────────┘      └────────────┬──────────────┘      └─────────────────────────┘
                                              │ Processing
                                              ▼
                               ┌───────────────────────────┐
                               │   EMG Analysis Pipeline   │
                               │                           │
                               │ ┌─────────────────────────┐ │
                               │ │   Signal Processing     │ │ ──► ezc3d, scipy, numpy
                               │ │   (Filtering, Envelope) │ │
                               │ └─────────────────────────┘ │
                               │ ┌─────────────────────────┐ │
                               │ │   Contraction Detection │ │ ──► MVC Thresholds
                               │ │   (Amplitude, Duration) │ │
                               │ └─────────────────────────┘ │
                               │ ┌─────────────────────────┐ │
                               │ │   Clinical Metrics      │ │ ──► RMS, MAV, MPF, MDF
                               │ │   (Fatigue, Compliance) │ │
                               │ └─────────────────────────┘ │
                               └───────────────────────────┘
```

### 3.2 Data Consistency Architecture

The system implements Single Source of Truth (SoT) for analytics data across the frontend.

**Backend Analytics Priority**: Backend analytics flags (`meets_mvc`, `meets_duration`, `is_good`) serve as the authoritative source. Frontend components use real-time values from backend calculations for consistency.

**Key Implementation**:
- Priority chain: Backend > Per-muscle > Global > Default thresholds
- Graceful fallback: Frontend calculations when backend flags unavailable
- Real-time sync: `MVCService.recalc()` triggers backend updates
- Consistent components: All hooks and UI components use backend data

### 3.3 Source Code Structure
```
src/
├── backend/
│   ├── api/
│   │   └── api.py                     # FastAPI endpoints and routing
│   ├── services/
│   │   ├── c3d_processor.py           # High-level C3D processing orchestration
│   │   ├── export_service.py          # Data export and formatting
│   │   └── mvc_service.py             # MVC threshold estimation service
│   ├── emg/
│   │   ├── emg_analysis.py            # Core EMG metrics calculation
│   │   └── signal_processing.py      # Low-level signal operations
│   ├── models/
│   │   └── models.py                  # Pydantic data models and validation
│   └── tests/                         # Comprehensive test suite
├── frontend/src/
│   ├── components/
│   │   ├── tabs/
│   │   │   ├── SignalPlotsTab/        # EMG signal visualization
│   │   │   ├── PerformanceTab/        # Clinical performance analytics
│   │   │   ├── SettingsTab/           # Therapist configuration interface
│   │   │   └── BFRMonitoringTab/      # Blood Flow Restriction monitoring
│   │   ├── auth/                      # Authentication components
│   │   ├── shared/                    # Reusable UI components
│   │   └── ui/                        # shadcn/ui base components
│   ├── hooks/
│   │   ├── usePerformanceMetrics.ts   # Performance calculation logic
│   │   ├── useContractionAnalysis.ts  # Contraction analysis utilities
│   │   └── __tests__/                 # Co-located unit tests
│   ├── services/
│   │   ├── logger.ts                  # Structured logging service
│   │   └── supabaseStorage.ts         # File storage operations
│   ├── store/
│   │   └── sessionStore.ts            # Zustand state management
│   └── types/
│       └── emg.ts                     # TypeScript EMG data models
```

### 3.4 Frontend (React 19 + TypeScript)

The frontend implements **React architecture** with TypeScript, utilizing concurrent rendering and component-based design optimized for clinical EMG data visualization.

**React 19 Architecture**
- **Zustand State Management**: Lightweight reactive state for session parameters and clinical settings
- **Component Architecture**: Tab-based interface with specialized EMG visualization components
- **Performance Optimization**: React.memo, useMemo, and useCallback for efficient rendering of large EMG datasets
- **Updates**: Client-side reactive calculations eliminate server round-trips for parameter changes

**Service Architecture**

The frontend implements a **layered service architecture** with services for clinical workflows:

- **Data Layer**: Supabase client for authentication and secure file storage
- **Business Logic Layer**: Custom hooks for EMG analysis, performance metrics, and contraction detection
- **Domain Services**: Clinical utilities for MVC calculations, muscle naming, and therapeutic compliance
- **Infrastructure Services**: Logging service with clinical audit trails and structured debugging

**Technical Implementation Highlights**
- **Clinical Data Processing**: EMG signal visualization with medical-grade precision and therapeutic threshold validation
- **Interactive Visualization**: Recharts-based charts with zoom, pan, and contraction highlighting using clinical color coding
- **Responsive Design**: WCAG-compliant interface optimized for clinical workflows and accessibility standards
- **Authentication Integration**: Role-based access with therapist/admin permissions and debug mode capabilities
- **Performance Optimization**: Downsampling for large EMG datasets while preserving clinical accuracy

### 3.5 Backend (Python / FastAPI)

The Python backend uses **FastAPI for asynchronous capabilities** and implements an **EMG processing architecture** with clear separation of clinical and technical concerns:

- **C3DProcessor**: Main orchestrator for GHOSTLY-specific file processing and channel detection
- **EMGAnalysis**: Core clinical algorithms for amplitude metrics, spectral analysis, and fatigue indices  
- **SignalProcessing**: Low-level EMG signal operations including filtering and envelope calculation
- **StatisticalEngine**: Temporal windowing and clinical statistical analysis for therapeutic assessment
- **MVCService**: Maximum Voluntary Contraction threshold estimation and management
- **ExportService**: Clinical data export in research-standard formats

### 3.6 Data & Persistence (Supabase)

Supabase provides **PostgreSQL database and secure file storage** with authentication. Clinical data schema includes:
- **Session Parameters**: Therapist-configured MVC thresholds, muscle naming, and therapeutic protocols
- **EMG Analytics**: Processed signal metrics with temporal statistics and clinical flags
- **Authentication**: Role-based access with therapist/admin permissions and audit logging
- **File Storage**: Secure C3D file storage with metadata and access controls

## 4. Tech Stack

| Layer | Technology |
|-------|------------|
| **Frontend** | React 19, TypeScript, Tailwind CSS, shadcn/ui, Recharts, Zustand |
| **Backend** | Python 3.10+, FastAPI, Pydantic, ezc3d, scipy, numpy, pandas |
| **EMG Processing** | Advanced signal processing algorithms, statistical analysis, clinical metrics |
| **Database** | Supabase (PostgreSQL) with real-time subscriptions |
| **Authentication** | Supabase Auth with role-based access control |
| **Storage** | Supabase Storage for secure C3D file management |
| **Testing** | Vitest (frontend), pytest (backend), comprehensive test coverage |
| **DevOps** | Poetry, Docker-ready, stateless architecture for cloud deployment |

## 5. Testing Strategy

The system includes a test suite with **65 total tests** across frontend and backend. Tests cover core functionality including EMG processing, data validation, and user interface components.

### 5.1 Current Test Results

**Frontend Tests: 20 passing** (August 2025)
- Performance metrics calculation (6 tests)
- Contraction filtering and EMG signal processing (11 tests)  
- Authentication patterns and state management (3 tests)

**Backend Tests: 45 passing** (August 2025)
- Core EMG analysis and C3D processing (15 tests)  
- **Webhook integration and validation (30 tests) ✅ PRODUCTION READY**
  - Real Supabase format support with database trigger handling
  - Robust error handling for corrupted C3D files  
  - Dual format compatibility for testing and production

**Build Quality**
- TypeScript compilation with strict mode
- ESLint code analysis
- Production build validation
- API documentation generation

### 5.2 Test Organization

**Backend Test Structure**:
```
backend/tests/
├── Core Tests (15 tests)
│   ├── test_emg_analysis.py      # EMG algorithms (6 tests)
│   ├── test_processor.py         # C3D processing (4 tests)
│   ├── test_contraction_flags.py # Validation logic (3 tests)
│   └── test_serialization.py     # Data serialization (2 tests)
└── webhook/                      # Webhook system (30 tests)
    ├── test_webhook_validation.py   # Payload validation (18 tests)
    └── test_integration_webhook.py  # Integration testing (12 tests)
```

**Frontend Test Structure**:
- React hooks with business logic
- Component behavior and user interactions
- Authentication workflows

### 5.3 Test Coverage

**Backend Testing**:
- EMG algorithm validation (RMS, MAV, MPF, MDF calculations)
- C3D file parsing and channel detection
- Contraction detection and validation logic
- Webhook integration and payload validation
- API endpoints and error handling

**Frontend Testing**:
- Performance metric calculations and edge cases
- EMG signal visualization components
- User interaction workflows
- Authentication and session management

**Key Test Scenarios**:
- File upload and processing pipeline
- Real-time parameter updates
- Error handling and edge cases
- Cross-browser compatibility

### 5.4 Running Tests

```bash
# Backend Tests (45 tests)
cd backend
python -m pytest tests/ -v                     # Run all tests
python -m pytest tests/ --ignore=tests/webhook # Core tests only (15)
python -m pytest tests/webhook/ -v             # Webhook tests only (30)

# Frontend Tests (20 tests)  
cd frontend
npm test -- --run                  # Run tests once
npm test -- --coverage             # Generate coverage report

# Build Validation
npm run build                       # Production build
npm run type-check                  # TypeScript validation
npm run lint                       # Code analysis
```

## 6. Development Scripts

This project includes comprehensive development scripts for setup, testing, and maintenance:

```bash
# Development Environment
./start_dev.sh                     # Start full development environment
./start_dev.sh --clean             # Clean install and start
./troubleshoot.sh                  # Diagnostic and troubleshooting

# Testing & Quality
npm test                           # Frontend tests
npm run test:coverage              # Test coverage reports  
npm run lint                       # Code quality analysis
npm run build                      # Production build validation

# Backend Operations
cd backend
python -m pytest                  # Backend test suite
uvicorn main:app --reload         # Development server
python -c "import emg_analysis; print('OK')" # Quick validation
```

## 7. Local Development

Follow these steps to set up the complete development environment.

### 7.1 Prerequisites
- **Python 3.10+** with Poetry for dependency management
- **Node.js LTS** (18+) with npm
- **Git** for version control
- **Supabase account** for authentication and storage (optional for local testing)

### 7.2 Quick Start

**1. Clone and Setup**
```bash
git clone https://github.com/yourusername/emg-c3d-analyzer.git
cd emg-c3d-analyzer

# Configure Poetry for in-project virtual environment
poetry config virtualenvs.in-project true
```

**2. Install Dependencies**
```bash
# Backend dependencies
poetry install

# Frontend dependencies  
cd frontend && npm install && cd ..
```

**3. Launch Development Environment**
```bash
# Make script executable and run
chmod +x start_dev.sh
./start_dev.sh
```

The application will be accessible at:
- **Frontend UI**: http://localhost:3000
- **Backend API**: http://localhost:8080
- **API Documentation**: http://localhost:8080/docs (Swagger UI)

### 7.3 Configuration

**Frontend API Connection**
```bash
# Create frontend/.env for custom backend URL
echo "REACT_APP_API_URL=http://localhost:8080" > frontend/.env
```

**Supabase Integration (Optional)**
```bash
# Add Supabase configuration to backend/.env
SUPABASE_URL=your_project_url
SUPABASE_KEY=your_service_role_key
```

### 7.4 Development Workflow

**Code Quality**
```bash
# Frontend
npm run lint                       # ESLint analysis
npm run type-check                 # TypeScript validation
npm run build                      # Production build test

# Backend  
cd backend
python -m pytest                  # Test suite
python -m pylint *.py             # Code analysis
```

**Troubleshooting**
```bash
./troubleshoot.sh                  # Comprehensive diagnostics
./start_dev.sh --clean            # Clean dependency reinstall
```

## 8. Roadmap

(To do)

## 9. License

This project is developed for research and educational purposes within the GHOSTLY+ rehabilitation gaming project. Please see the `LICENSE.md` file for detailed terms and conditions.

---

**About the GHOSTLY+ EMG Analyzer**

🏥 **Research Platform**: EMG analysis system designed for rehabilitation research and therapeutic assessment within the GHOSTLY serious gaming ecosystem. This platform demonstrates healthcare technology architecture with clinical workflow integration, EMG processing, and therapeutic analytics.

The system combines web technologies with biomedical signal processing to create a platform for EMG-based rehabilitation assessment and research.

**Contributors**: Research team focused on rehabilitation technology, biomedical signal processing, and clinical workflow optimization.

**Technologies**: React 19, FastAPI, EMG signal processing, clinical analytics, TypeScript, Python scientific computing.